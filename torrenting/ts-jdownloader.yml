services:
  tailscale-jdownloader:
    image: tailscale/tailscale:latest
    container_name: ts-jdownloader
    environment:
      - TS_AUTHKEY=${JDOWNLOADER_TS_AUTH_KEY}
      - TS_EXTRA_ARGS=--advertise-tags=tag:container
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/jdownloader.json
      - TS_USERSPACE=false
    volumes:
      - ${CFG_PATH}/tailscale/tailscale-jdownloader/state:/var/lib/tailscale
      - ${CFG_PATH}/tailscale/tailscale-jdownloader/config:/config
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped
    network_mode: service:vpn

      
  vpn:
    image: qmcgaw/gluetun:latest
    container_name: vpn-jdownloder
    hostname: jdownloader
    dns:
     - 8.8.8.8
     - 100.100.100.100
    cap_add:
      - net_admin
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - OPENVPN_USER=${OPENVPN_USER}
      - OPENVPN_PASSWORD=${OPENVPN_PASS}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES}
    networks:
     - tailnet

      
  jdownloader:
    image: jlesage/jdownloader-2:latest
    container_name: jdownloader
    user: ${user}:${group}
    labels:
        - traefik.enable=true
        ## Redirect to HTTPS
        - traefik.http.routers.jdownloader-https.tls=true
        - traefik.http.routers.jdownloader-https.tls.certresolver=${TRAEFIK_CERTRESOLVER}
        - traefik.http.routers.jdownloader-https.entrypoints=${TRAEFIK_ENTRYPOINT}
        - traefik.http.routers.jdownloader-https.rule=Host(`${JDOWNLOADER_DOMAIN}`)
        - traefik.http.services.jdownloader-https.loadbalancer.server.port=5800
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - ${CFG_PATH}/jdownloader:/config
      - ${DATA_PATH}:/downloads

    network_mode: service:tailscale-jdownloader

networks:
  tailnet:
    name: tailnet
    external: true
